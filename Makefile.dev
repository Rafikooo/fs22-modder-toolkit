# FS22 Modder Toolkit - Main Makefile
# Centralized build system for all features

.PHONY: help all dev clean docs json stubs install test

# Default target
.DEFAULT_GOAL := help

# Load environment
-include .env.local

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

##@ General

help: ## Show this help message
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo "$(BLUE)  FS22 Modder Toolkit - Build System$(NC)"
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Usage: make $(BLUE)<target>$(NC)\n\n"} \
		/^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2 } \
		/^##@/ { printf "\n$(YELLOW)%s$(NC)\n", substr($$0, 5) }' $(MAKEFILE_LIST)

##@ Development

dev: ## Quick dev mode (single global: g_currentMission, depth 3)
	@echo "$(BLUE)▶ Running in DEV mode (single global)...$(NC)"
	@EXPORT_GLOBAL=g_currentMission EXPORT_DEPTH=3 ./run_pipeline.sh

dev-all-depths: ## Dev mode with all depths (1,2,3) for single global
	@echo "$(BLUE)▶ Running in DEV mode (all depths)...$(NC)"
	@EXPORT_GLOBAL=g_currentMission EXPORT_DEPTH="" ./run_pipeline.sh

test: ## Test pipeline with minimal data
	@echo "$(BLUE)▶ Running pipeline test...$(NC)"
	@EXPORT_GLOBAL=g_achievementManager EXPORT_DEPTH=1 ./run_pipeline.sh

##@ Production

all: ## Full build (ALL globals - ~240 exports + engine functions)
	@echo "$(RED)⚠ WARNING: This will process ~240 globals! ⚠$(NC)"
	@read -p "Continue? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		EXPORT_GLOBAL="" ./run_pipeline.sh; \
	else \
		echo "$(YELLOW)Cancelled.$(NC)"; \
	fi

production: all ## Alias for 'all' (full production build)

##@ Individual Features

json: ## Convert XML to JSON (respects .env.local filters)
	@echo "$(BLUE)▶ Running JSON conversion...$(NC)"
	@RUN_LUA_STUBS=false RUN_DOCS_GENERATION=false ./run_pipeline.sh

stubs: ## Generate Lua type stubs (respects .env.local filters)
	@echo "$(BLUE)▶ Generating Lua stubs...$(NC)"
	@RUN_JSON_CONVERSION=false RUN_DOCS_GENERATION=false ./run_pipeline.sh

docs: ## Generate documentation (respects .env.local filters)
	@echo "$(BLUE)▶ Generating documentation...$(NC)"
	@RUN_LUA_STUBS=false ./run_pipeline.sh

docs-verbose: ## Generate docs with verbose output (for debugging)
	@echo "$(BLUE)▶ Generating documentation (VERBOSE mode)...$(NC)"
	@VERBOSE=true RUN_LUA_STUBS=false ./run_pipeline.sh

docs-serve: docs ## Generate docs and start dev server
	@echo "$(BLUE)▶ Starting Docusaurus dev server...$(NC)"
	@cd dist/docs && npm start

docs-build: docs ## Generate docs and build static site
	@echo "$(BLUE)▶ Building Docusaurus static site...$(NC)"
	@cd dist/docs && npm run build

build-docs: ## Build documentation site (no regeneration)
	@echo "$(BLUE)▶ Building Docusaurus static site...$(NC)"
	@cd dist/docs && npm run build
	@echo ""
	@echo "$(GREEN)✓ Documentation site built!$(NC)"
	@echo ""
	@echo "$(YELLOW)To view the site:$(NC)"
	@echo "  Option 1 (HTTP server - recommended):"
	@echo "    cd dist/docs/build"
	@echo "    python3 -m http.server 8000"
	@echo "    Open: $(BLUE)http://localhost:8000$(NC)"
	@echo ""
	@echo "  Option 2 (file:// protocol):"
	@echo "    open dist/docs/build/index.html"
	@echo ""

serve-docs: ## Serve built documentation (requires build-docs first)
	@echo "$(BLUE)▶ Starting HTTP server for built docs...$(NC)"
	@echo "$(YELLOW)Opening browser at http://localhost:8000$(NC)"
	@cd dist/docs/build && python3 -m http.server 8000

##@ Installation

install: ## Install all dependencies
	@echo "$(BLUE)▶ Installing dependencies...$(NC)"
	@echo "$(YELLOW)  Installing Docusaurus dependencies...$(NC)"
	@cd dist/docs && npm install
	@echo "$(GREEN)✓ All dependencies installed$(NC)"

##@ Cleanup

clean: ## Clean all generated outputs
	@echo "$(BLUE)▶ Cleaning outputs...$(NC)"
	@rm -rf data/json/*
	@rm -rf data/stubs/*
	@rm -rf data/engine-sigs/*
	@rm -rf dist/docs/docs/*
	@rm -rf dist/docs/build
	@rm -rf dist/docs/.docusaurus
	@echo "$(GREEN)✓ Cleaned all outputs$(NC)"

clean-docs: ## Clean only documentation outputs
	@echo "$(BLUE)▶ Cleaning documentation...$(NC)"
	@rm -rf dist/docs/docs/*
	@rm -rf dist/docs/build
	@rm -rf dist/docs/.docusaurus
	@echo "$(GREEN)✓ Cleaned documentation$(NC)"

clean-json: ## Clean only JSON outputs
	@echo "$(BLUE)▶ Cleaning JSON outputs...$(NC)"
	@rm -rf data/json/*
	@echo "$(GREEN)✓ Cleaned JSON outputs$(NC)"

clean-stubs: ## Clean only Lua stubs
	@echo "$(BLUE)▶ Cleaning Lua stubs...$(NC)"
	@rm -rf data/stubs/*
	@echo "$(GREEN)✓ Cleaned Lua stubs$(NC)"

clean-engine-sigs: ## Clean only engine signatures
	@echo "$(BLUE)▶ Cleaning engine signatures...$(NC)"
	@rm -rf data/engine-sigs/*
	@echo "$(GREEN)✓ Cleaned engine signatures$(NC)"

##@ Quick Workflows

quick-docs: ## Quick: Generate docs for g_currentMission only
	@echo "$(BLUE)▶ Quick docs generation (g_currentMission)...$(NC)"
	@EXPORT_GLOBAL=g_currentMission EXPORT_DEPTH=3 \
		RUN_JSON_CONVERSION=false RUN_LUA_STUBS=false \
		./run_pipeline.sh
	@cd dist/docs && npm start

quick-all: ## Quick: Full pipeline for g_currentMission only
	@echo "$(BLUE)▶ Quick full pipeline (g_currentMission)...$(NC)"
	@EXPORT_GLOBAL=g_currentMission EXPORT_DEPTH=3 ./run_pipeline.sh

rebuild: clean all ## Clean and rebuild everything

##@ Information

info: ## Show current configuration
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo "$(BLUE)  Current Configuration (.env.local)$(NC)"
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo ""
	@echo "$(YELLOW)Export Settings:$(NC)"
	@echo "  EXPORT_GLOBAL:  $(shell grep EXPORT_GLOBAL .env.local | cut -d= -f2 | sed 's/"//g' || echo 'ALL')"
	@echo "  EXPORT_DEPTH:   $(shell grep EXPORT_DEPTH .env.local | cut -d= -f2 | sed 's/"//g' || echo 'ALL')"
	@echo ""
	@echo "$(YELLOW)Feature Toggles:$(NC)"
	@echo "  JSON:           $(shell grep RUN_JSON_CONVERSION .env.local | cut -d= -f2)"
	@echo "  Stubs:          $(shell grep RUN_LUA_STUBS .env.local | cut -d= -f2)"
	@echo "  Docs:           $(shell grep RUN_DOCS_GENERATION .env.local | cut -d= -f2)"
	@echo ""
	@echo "$(YELLOW)Latest Runtime Export:$(NC)"
	@ls -td data/schemas 2>/dev/null | head -1 | xargs basename || echo "  None found"
	@echo ""

list-sessions: ## List available runtime export sessions
	@echo "$(BLUE)Available runtime export sessions:$(NC)"
	@ls -td data/schemas 2>/dev/null | \
		while read dir; do \
			session=$$(basename $$dir); \
			count=$$(find $$dir -name "*.xml" -type f | wc -l | tr -d ' '); \
			echo "  $$session ($$count XML files)"; \
		done || echo "  $(RED)No sessions found$(NC)"

list-globals: ## List available globals in latest session
	@echo "$(BLUE)Available globals in latest session:$(NC)"
	@latest=$$(ls -td data/schemas 2>/dev/null | head -1); \
	if [ -n "$$latest" ]; then \
		find $$latest -maxdepth 1 -type d -name "g_*" | \
			xargs -n1 basename | sort | nl; \
	else \
		echo "  $(RED)No sessions found$(NC)"; \
	fi

stats: ## Show statistics about generated files
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo "$(BLUE)  Generated Files Statistics$(NC)"
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo ""
	@echo "$(YELLOW)JSON Files:$(NC)"
	@find data/json -name "*.json" 2>/dev/null | wc -l | xargs echo "  Count:" || echo "  0"
	@du -sh data/json 2>/dev/null | cut -f1 | xargs echo "  Size:" || echo "  0"
	@echo ""
	@echo "$(YELLOW)Lua Stubs:$(NC)"
	@find data/stubs -name "*.lua" 2>/dev/null | wc -l | xargs echo "  Count:" || echo "  0"
	@du -sh data/stubs 2>/dev/null | cut -f1 | xargs echo "  Size:" || echo "  0"
	@echo ""
	@echo "$(YELLOW)Engine Signatures:$(NC)"
	@find data/engine-sigs -name "*.lua" 2>/dev/null | wc -l | xargs echo "  Count:" || echo "  0"
	@du -sh data/engine-sigs 2>/dev/null | cut -f1 | xargs echo "  Size:" || echo "  0"
	@echo ""
	@echo "$(YELLOW)Documentation:$(NC)"
	@find dist/docs/docs -name "*.md" 2>/dev/null | wc -l | xargs echo "  Count:" || echo "  0"
	@du -sh dist/docs/docs 2>/dev/null | cut -f1 | xargs echo "  Size:" || echo "  0"
	@echo ""

##@ Examples

examples: ## Show usage examples
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo "$(BLUE)  Common Workflows$(NC)"
	@echo "$(BLUE)━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━$(NC)"
	@echo ""
	@echo "$(YELLOW)Quick Development:$(NC)"
	@echo "  $$ make dev              # Single global (g_currentMission, depth 3)"
	@echo "  $$ make quick-docs       # Docs only + start server"
	@echo "  $$ make test             # Minimal test (g_achievementManager)"
	@echo ""
	@echo "$(YELLOW)Individual Features:$(NC)"
	@echo "  $$ make json             # Only JSON conversion"
	@echo "  $$ make stubs            # Only Lua stubs"
	@echo "  $$ make docs             # Only documentation"
	@echo ""
	@echo "$(YELLOW)Full Production:$(NC)"
	@echo "  $$ make all              # Process ALL ~240 globals + engine"
	@echo "  $$ make production       # Same as 'all'"
	@echo ""
	@echo "$(YELLOW)Cleanup:$(NC)"
	@echo "  $$ make clean            # Clean everything"
	@echo "  $$ make clean-docs       # Clean only docs"
	@echo "  $$ make rebuild          # Clean + rebuild all"
	@echo ""
	@echo "$(YELLOW)Information:$(NC)"
	@echo "  $$ make info             # Show current config"
	@echo "  $$ make stats            # Show file statistics"
	@echo "  $$ make list-globals     # List available globals"
	@echo ""
